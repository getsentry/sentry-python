
  <!DOCTYPE html>
<html lang="en" data-accent-color="violet" data-content_root="../../">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>sentry_sdk.profiler - sentry-python 2.0.0a1 documentation</title>
    <link rel="index" title="Index" href="../../genindex.html" /><link rel="search" title="Search" href="../../search.html" />

  <script>
    function setColorMode(t){let e=document.documentElement;e.setAttribute("data-color-mode",t);let a=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,s=t;"auto"===t&&(s=a?"dark":"light"),"light"===s?(e.classList.remove("dark"),e.classList.add("light")):(e.classList.remove("light"),e.classList.add("dark"))}
    setColorMode(sessionStorage._theme||"auto");
  </script><link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=aecf457f" />
    <link rel="stylesheet" type="text/css" href="../../_static/shibuya.css?v=b6637a78" />
    <link media="print" rel="stylesheet" type="text/css" href="../../_static/print.css?v=20ff2c19" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --sy-f-text: "Inter", var(--sy-f-sys), var(--sy-f-cjk), sans-serif;
  --sy-f-heading: "Inter", var(--sy-f-sys), var(--sy-f-cjk), sans-serif;
}
</style>
    <meta property="og:type" content="website"/><meta property="og:title" content="sentry_sdk.profiler"/>
<meta name="twitter:card" content="summary"/></head>
<body><div class="document"><div class="sy-head">
  <div class="sy-head-blur"></div>
  <div class="sy-head-inner sy-container mx-auto">
    <a class="sy-head-brand mr-4" href="../../index.html">
      
      
      <strong>sentry-python</strong>
    </a>
    <div class="sy-head-links" id="NavLinks">
      <nav class="sy-head-nav"></nav>
      <div class="sy-head-extra flex items-center print:hidden">
<form class="searchbox flex items-center" action="../../search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <kbd>/</kbd>
</form>
        
        
        <div class="sy-head-social flex items-center">
            <a class="flex items-center" href="https://github.com/getsentry/sentry-python" aria-label="GitHub">
              <i class="i-icon github"></i>
            </a>
        </div>
      </div>
    </div>
    <div class="sy-head-actions flex items-center shrink-0 print:hidden">
      <button class="js-theme theme-switch flex items-center"
        data-aria-auto="Switch to light color mode"
        data-aria-light="Switch to dark color mode"
        data-aria-dark="Switch to auto color mode">
        <i class="i-icon theme-icon"></i>
      </button>
      <button class="md:hidden flex items-center js-menu" aria-label="Menu" type="button" aria-controls="NavLinks" aria-expanded="false">
        <div class="hamburger">
          <span class="hamburger_1"></span>
          <span class="hamburger_2 -translate-x-2"></span>
          <span class="hamburger_3 -translate-x-1"></span>
        </div>
      </button>
    </div>
  </div>
</div>
<div class="sy-page sy-container flex mx-auto">
  <aside id="lside" class="sy-lside md:w-72 md:shrink-0 print:hidden">
    <div class="sy-lside-inner md:sticky">
      <div class="sy-scrollbar p-6">
        <div class="globaltoc" data-expand-depth="0"><ul>
<li class="toctree-l1"><a class="reference internal" href="../../api.html">Top Level API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../integrations.html">Integrations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../apidocs.html">API Docs</a></li>
</ul>

        </div>
      </div>
      
    </div>
  </aside>
  <div class="lside-overlay js-menu" role="button" aria-label="Close left sidebar" aria-controls="lside" aria-expanded="false"></div>
  <aside id="rside" class="sy-rside pb-3 w-64 shrink-0 order-last">
    <button class="rside-close js-menu xl:hidden" aria-label="Close Table of Contents" type="button" aria-controls="rside" aria-expanded="false">
      <i class="i-icon close"></i>
    </button>
    <div class="sy-scrollbar sy-rside-inner px-6 xl:top-16 xl:sticky xl:pl-0 pt-6 pb-4"><div id="ethical-ad-placement" data-ea-publisher="readthedocs"></div>
    </div>
  </aside>
  <div class="rside-overlay js-menu" role="button" aria-label="Close Table of Contents" aria-controls="rside" aria-expanded="false"></div>
  <main class="sy-main w-full max-sm:max-w-full print:pt-6">
    <div class="sy-breadcrumbs" role="navigation">
  <div class="sy-breadcrumbs-inner flex items-center">
    <div class="md:hidden mr-3">
      <button class="js-menu" aria-label="Menu" type="button" aria-controls="lside" aria-expanded="false">
        <i class="i-icon menu"></i>
      </button>
    </div>
    <ol class="flex-1" itemscope itemtype="https://schema.org/BreadcrumbList">
      
      
      <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
        <a itemprop="item" href="../../index.html"><span itemprop="name">sentry-python</span></a>
        <span>/</span>
        <meta itemprop="position" content="1" />
      </li>
      
      <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
        <a itemprop="item" href="../index.html"><span itemprop="name">Module code</span></a>
        <span>/</span>
        <meta itemprop="position" content="2" />
      </li>
      
      <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
        <strong itemprop="name">sentry_sdk.profiler</strong>
        <meta itemprop="position" content="3" />
      </li>
      
      
    </ol>
    <div class="xl:hidden ml-1">
      <button class="js-menu" aria-label="Show table of contents" type="button" aria-controls="rside"
        aria-expanded="false">
        <i class="i-icon outdent"></i>
      </button>
    </div>
  </div>
</div>
    <div class="flex flex-col break-words justify-between">
      <div class="min-w-0 max-w-6xl px-6 pb-6 pt-8 xl:px-12">
        <article class="yue" role="main">
          <h1>Source code for sentry_sdk.profiler</h1><div class="highlight"><pre>
<span></span><span id="1-1"><span class="sd">&quot;&quot;&quot;</span>
</span><span id="1-2"><span class="sd">This file is originally based on code from https://github.com/nylas/nylas-perftools,</span>
</span><span id="1-3"><span class="sd">which is published under the following license:</span>
</span><span id="1-4">
</span><span id="1-5"><span class="sd">The MIT License (MIT)</span>
</span><span id="1-6">
</span><span id="1-7"><span class="sd">Copyright (c) 2014 Nylas</span>
</span><span id="1-8">
</span><span id="1-9"><span class="sd">Permission is hereby granted, free of charge, to any person obtaining a copy</span>
</span><span id="1-10"><span class="sd">of this software and associated documentation files (the &quot;Software&quot;), to deal</span>
</span><span id="1-11"><span class="sd">in the Software without restriction, including without limitation the rights</span>
</span><span id="1-12"><span class="sd">to use, copy, modify, merge, publish, distribute, sublicense, and/or sell</span>
</span><span id="1-13"><span class="sd">copies of the Software, and to permit persons to whom the Software is</span>
</span><span id="1-14"><span class="sd">furnished to do so, subject to the following conditions:</span>
</span><span id="1-15">
</span><span id="1-16"><span class="sd">The above copyright notice and this permission notice shall be included in all</span>
</span><span id="1-17"><span class="sd">copies or substantial portions of the Software.</span>
</span><span id="1-18">
</span><span id="1-19"><span class="sd">THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR</span>
</span><span id="1-20"><span class="sd">IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,</span>
</span><span id="1-21"><span class="sd">FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE</span>
</span><span id="1-22"><span class="sd">AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER</span>
</span><span id="1-23"><span class="sd">LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,</span>
</span><span id="1-24"><span class="sd">OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE</span>
</span><span id="1-25"><span class="sd">SOFTWARE.</span>
</span><span id="1-26"><span class="sd">&quot;&quot;&quot;</span>
</span><span id="1-27">
</span><span id="1-28"><span class="kn">import</span> <span class="nn">atexit</span>
</span><span id="1-29"><span class="kn">import</span> <span class="nn">os</span>
</span><span id="1-30"><span class="kn">import</span> <span class="nn">platform</span>
</span><span id="1-31"><span class="kn">import</span> <span class="nn">random</span>
</span><span id="1-32"><span class="kn">import</span> <span class="nn">sys</span>
</span><span id="1-33"><span class="kn">import</span> <span class="nn">threading</span>
</span><span id="1-34"><span class="kn">import</span> <span class="nn">time</span>
</span><span id="1-35"><span class="kn">import</span> <span class="nn">uuid</span>
</span><span id="1-36"><span class="kn">from</span> <span class="nn">abc</span> <span class="kn">import</span> <span class="n">ABC</span><span class="p">,</span> <span class="n">abstractmethod</span>
</span><span id="1-37"><span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">deque</span>
</span><span id="1-38">
</span><span id="1-39"><span class="kn">import</span> <span class="nn">sentry_sdk</span>
</span><span id="1-40"><span class="kn">from</span> <span class="nn">sentry_sdk._compat</span> <span class="kn">import</span> <span class="n">PY311</span>
</span><span id="1-41"><span class="kn">from</span> <span class="nn">sentry_sdk._lru_cache</span> <span class="kn">import</span> <span class="n">LRUCache</span>
</span><span id="1-42"><span class="kn">from</span> <span class="nn">sentry_sdk._types</span> <span class="kn">import</span> <span class="n">TYPE_CHECKING</span>
</span><span id="1-43"><span class="kn">from</span> <span class="nn">sentry_sdk.utils</span> <span class="kn">import</span> <span class="p">(</span>
</span><span id="1-44">    <span class="n">capture_internal_exception</span><span class="p">,</span>
</span><span id="1-45">    <span class="n">filename_for_module</span><span class="p">,</span>
</span><span id="1-46">    <span class="n">is_valid_sample_rate</span><span class="p">,</span>
</span><span id="1-47">    <span class="n">logger</span><span class="p">,</span>
</span><span id="1-48">    <span class="n">nanosecond_time</span><span class="p">,</span>
</span><span id="1-49">    <span class="n">set_in_app_in_frames</span><span class="p">,</span>
</span><span id="1-50"><span class="p">)</span>
</span><span id="1-51">
</span><span id="1-52"><span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
</span><span id="1-53">    <span class="kn">from</span> <span class="nn">types</span> <span class="kn">import</span> <span class="n">FrameType</span>
</span><span id="1-54">    <span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span>
</span><span id="1-55">    <span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Callable</span>
</span><span id="1-56">    <span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Deque</span>
</span><span id="1-57">    <span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span>
</span><span id="1-58">    <span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span>
</span><span id="1-59">    <span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span>
</span><span id="1-60">    <span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Set</span>
</span><span id="1-61">    <span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Sequence</span>
</span><span id="1-62">    <span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Tuple</span>
</span><span id="1-63">    <span class="kn">from</span> <span class="nn">typing_extensions</span> <span class="kn">import</span> <span class="n">TypedDict</span>
</span><span id="1-64">
</span><span id="1-65">    <span class="kn">import</span> <span class="nn">sentry_sdk.tracing</span>
</span><span id="1-66">    <span class="kn">from</span> <span class="nn">sentry_sdk._types</span> <span class="kn">import</span> <span class="n">SamplingContext</span><span class="p">,</span> <span class="n">ProfilerMode</span>
</span><span id="1-67">
</span><span id="1-68">    <span class="n">ThreadId</span> <span class="o">=</span> <span class="nb">str</span>
</span><span id="1-69">
</span><span id="1-70">    <span class="n">ProcessedSample</span> <span class="o">=</span> <span class="n">TypedDict</span><span class="p">(</span>
</span><span id="1-71">        <span class="s2">&quot;ProcessedSample&quot;</span><span class="p">,</span>
</span><span id="1-72">        <span class="p">{</span>
</span><span id="1-73">            <span class="s2">&quot;elapsed_since_start_ns&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="1-74">            <span class="s2">&quot;thread_id&quot;</span><span class="p">:</span> <span class="n">ThreadId</span><span class="p">,</span>
</span><span id="1-75">            <span class="s2">&quot;stack_id&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="1-76">        <span class="p">},</span>
</span><span id="1-77">    <span class="p">)</span>
</span><span id="1-78">
</span><span id="1-79">    <span class="n">ProcessedStack</span> <span class="o">=</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>
</span><span id="1-80">
</span><span id="1-81">    <span class="n">ProcessedFrame</span> <span class="o">=</span> <span class="n">TypedDict</span><span class="p">(</span>
</span><span id="1-82">        <span class="s2">&quot;ProcessedFrame&quot;</span><span class="p">,</span>
</span><span id="1-83">        <span class="p">{</span>
</span><span id="1-84">            <span class="s2">&quot;abs_path&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="1-85">            <span class="s2">&quot;filename&quot;</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
</span><span id="1-86">            <span class="s2">&quot;function&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="1-87">            <span class="s2">&quot;lineno&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="1-88">            <span class="s2">&quot;module&quot;</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
</span><span id="1-89">        <span class="p">},</span>
</span><span id="1-90">    <span class="p">)</span>
</span><span id="1-91">
</span><span id="1-92">    <span class="n">ProcessedThreadMetadata</span> <span class="o">=</span> <span class="n">TypedDict</span><span class="p">(</span>
</span><span id="1-93">        <span class="s2">&quot;ProcessedThreadMetadata&quot;</span><span class="p">,</span>
</span><span id="1-94">        <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">},</span>
</span><span id="1-95">    <span class="p">)</span>
</span><span id="1-96">
</span><span id="1-97">    <span class="n">ProcessedProfile</span> <span class="o">=</span> <span class="n">TypedDict</span><span class="p">(</span>
</span><span id="1-98">        <span class="s2">&quot;ProcessedProfile&quot;</span><span class="p">,</span>
</span><span id="1-99">        <span class="p">{</span>
</span><span id="1-100">            <span class="s2">&quot;frames&quot;</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ProcessedFrame</span><span class="p">],</span>
</span><span id="1-101">            <span class="s2">&quot;stacks&quot;</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ProcessedStack</span><span class="p">],</span>
</span><span id="1-102">            <span class="s2">&quot;samples&quot;</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ProcessedSample</span><span class="p">],</span>
</span><span id="1-103">            <span class="s2">&quot;thread_metadata&quot;</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">ThreadId</span><span class="p">,</span> <span class="n">ProcessedThreadMetadata</span><span class="p">],</span>
</span><span id="1-104">        <span class="p">},</span>
</span><span id="1-105">    <span class="p">)</span>
</span><span id="1-106">
</span><span id="1-107">    <span class="n">ProfileContext</span> <span class="o">=</span> <span class="n">TypedDict</span><span class="p">(</span>
</span><span id="1-108">        <span class="s2">&quot;ProfileContext&quot;</span><span class="p">,</span>
</span><span id="1-109">        <span class="p">{</span><span class="s2">&quot;profile_id&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">},</span>
</span><span id="1-110">    <span class="p">)</span>
</span><span id="1-111">
</span><span id="1-112">    <span class="n">FrameId</span> <span class="o">=</span> <span class="n">Tuple</span><span class="p">[</span>
</span><span id="1-113">        <span class="nb">str</span><span class="p">,</span>  <span class="c1"># abs_path</span>
</span><span id="1-114">        <span class="nb">int</span><span class="p">,</span>  <span class="c1"># lineno</span>
</span><span id="1-115">        <span class="nb">str</span><span class="p">,</span>  <span class="c1"># function</span>
</span><span id="1-116">    <span class="p">]</span>
</span><span id="1-117">    <span class="n">FrameIds</span> <span class="o">=</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">FrameId</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
</span><span id="1-118">
</span><span id="1-119">    <span class="c1"># The exact value of this id is not very meaningful. The purpose</span>
</span><span id="1-120">    <span class="c1"># of this id is to give us a compact and unique identifier for a</span>
</span><span id="1-121">    <span class="c1"># raw stack that can be used as a key to a dictionary so that it</span>
</span><span id="1-122">    <span class="c1"># can be used during the sampled format generation.</span>
</span><span id="1-123">    <span class="n">StackId</span> <span class="o">=</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span>
</span><span id="1-124">
</span><span id="1-125">    <span class="n">ExtractedStack</span> <span class="o">=</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">StackId</span><span class="p">,</span> <span class="n">FrameIds</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">ProcessedFrame</span><span class="p">]]</span>
</span><span id="1-126">    <span class="n">ExtractedSample</span> <span class="o">=</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">ThreadId</span><span class="p">,</span> <span class="n">ExtractedStack</span><span class="p">]]</span>
</span><span id="1-127">
</span><span id="1-128">
</span><span id="1-129"><span class="k">try</span><span class="p">:</span>
</span><span id="1-130">    <span class="kn">from</span> <span class="nn">gevent</span> <span class="kn">import</span> <span class="n">get_hub</span> <span class="k">as</span> <span class="n">get_gevent_hub</span>  <span class="c1"># type: ignore</span>
</span><span id="1-131">    <span class="kn">from</span> <span class="nn">gevent.monkey</span> <span class="kn">import</span> <span class="n">get_original</span><span class="p">,</span> <span class="n">is_module_patched</span>  <span class="c1"># type: ignore</span>
</span><span id="1-132">    <span class="kn">from</span> <span class="nn">gevent.threadpool</span> <span class="kn">import</span> <span class="n">ThreadPool</span>  <span class="c1"># type: ignore</span>
</span><span id="1-133">
</span><span id="1-134">    <span class="n">thread_sleep</span> <span class="o">=</span> <span class="n">get_original</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="s2">&quot;sleep&quot;</span><span class="p">)</span>
</span><span id="1-135"><span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
</span><span id="1-136">
</span><span id="1-137">    <span class="k">def</span> <span class="nf">get_gevent_hub</span><span class="p">():</span>
</span><span id="1-138">        <span class="c1"># type: () -&gt; Any</span>
</span><span id="1-139">        <span class="k">return</span> <span class="kc">None</span>
</span><span id="1-140">
</span><span id="1-141">    <span class="n">thread_sleep</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">sleep</span>
</span><span id="1-142">
</span><span id="1-143">    <span class="k">def</span> <span class="nf">is_module_patched</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="1-144">        <span class="c1"># type: (*Any, **Any) -&gt; bool</span>
</span><span id="1-145">        <span class="c1"># unable to import from gevent means no modules have been patched</span>
</span><span id="1-146">        <span class="k">return</span> <span class="kc">False</span>
</span><span id="1-147">
</span><span id="1-148">    <span class="n">ThreadPool</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="1-149">
</span><span id="1-150">
</span><span id="1-151"><span class="k">def</span> <span class="nf">is_gevent</span><span class="p">():</span>
</span><span id="1-152">    <span class="c1"># type: () -&gt; bool</span>
</span><span id="1-153">    <span class="k">return</span> <span class="n">is_module_patched</span><span class="p">(</span><span class="s2">&quot;threading&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">is_module_patched</span><span class="p">(</span><span class="s2">&quot;_thread&quot;</span><span class="p">)</span>
</span><span id="1-154">
</span><span id="1-155">
</span><span id="1-156"><span class="n">_scheduler</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># type: Optional[Scheduler]</span>
</span><span id="1-157">
</span><span id="1-158"><span class="c1"># The default sampling frequency to use. This is set at 101 in order to</span>
</span><span id="1-159"><span class="c1"># mitigate the effects of lockstep sampling.</span>
</span><span id="1-160"><span class="n">DEFAULT_SAMPLING_FREQUENCY</span> <span class="o">=</span> <span class="mi">101</span>
</span><span id="1-161">
</span><span id="1-162">
</span><span id="1-163"><span class="c1"># The minimum number of unique samples that must exist in a profile to be</span>
</span><span id="1-164"><span class="c1"># considered valid.</span>
</span><span id="1-165"><span class="n">PROFILE_MINIMUM_SAMPLES</span> <span class="o">=</span> <span class="mi">2</span>
</span><span id="1-166">
</span><span id="1-167">
</span><span id="1-168"><span class="k">def</span> <span class="nf">has_profiling_enabled</span><span class="p">(</span><span class="n">options</span><span class="p">):</span>
</span><span id="1-169">    <span class="c1"># type: (Dict[str, Any]) -&gt; bool</span>
</span><span id="1-170">    <span class="n">profiles_sampler</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;profiles_sampler&quot;</span><span class="p">]</span>
</span><span id="1-171">    <span class="k">if</span> <span class="n">profiles_sampler</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-172">        <span class="k">return</span> <span class="kc">True</span>
</span><span id="1-173">
</span><span id="1-174">    <span class="n">profiles_sample_rate</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;profiles_sample_rate&quot;</span><span class="p">]</span>
</span><span id="1-175">    <span class="k">if</span> <span class="n">profiles_sample_rate</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">profiles_sample_rate</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="1-176">        <span class="k">return</span> <span class="kc">True</span>
</span><span id="1-177">
</span><span id="1-178">    <span class="n">profiles_sample_rate</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;_experiments&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;profiles_sample_rate&quot;</span><span class="p">)</span>
</span><span id="1-179">    <span class="k">if</span> <span class="n">profiles_sample_rate</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-180">        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="1-181">            <span class="s2">&quot;_experiments[&#39;profiles_sample_rate&#39;] is deprecated. &quot;</span>
</span><span id="1-182">            <span class="s2">&quot;Please use the non-experimental profiles_sample_rate option &quot;</span>
</span><span id="1-183">            <span class="s2">&quot;directly.&quot;</span>
</span><span id="1-184">        <span class="p">)</span>
</span><span id="1-185">        <span class="k">if</span> <span class="n">profiles_sample_rate</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="1-186">            <span class="k">return</span> <span class="kc">True</span>
</span><span id="1-187">
</span><span id="1-188">    <span class="k">return</span> <span class="kc">False</span>
</span><span id="1-189">
</span><span id="1-190">
</span><span id="1-191"><span class="k">def</span> <span class="nf">setup_profiler</span><span class="p">(</span><span class="n">options</span><span class="p">):</span>
</span><span id="1-192">    <span class="c1"># type: (Dict[str, Any]) -&gt; bool</span>
</span><span id="1-193">    <span class="k">global</span> <span class="n">_scheduler</span>
</span><span id="1-194">
</span><span id="1-195">    <span class="k">if</span> <span class="n">_scheduler</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-196">        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;[Profiling] Profiler is already setup&quot;</span><span class="p">)</span>
</span><span id="1-197">        <span class="k">return</span> <span class="kc">False</span>
</span><span id="1-198">
</span><span id="1-199">    <span class="n">frequency</span> <span class="o">=</span> <span class="n">DEFAULT_SAMPLING_FREQUENCY</span>
</span><span id="1-200">
</span><span id="1-201">    <span class="k">if</span> <span class="n">is_gevent</span><span class="p">():</span>
</span><span id="1-202">        <span class="c1"># If gevent has patched the threading modules then we cannot rely on</span>
</span><span id="1-203">        <span class="c1"># them to spawn a native thread for sampling.</span>
</span><span id="1-204">        <span class="c1"># Instead we default to the GeventScheduler which is capable of</span>
</span><span id="1-205">        <span class="c1"># spawning native threads within gevent.</span>
</span><span id="1-206">        <span class="n">default_profiler_mode</span> <span class="o">=</span> <span class="n">GeventScheduler</span><span class="o">.</span><span class="n">mode</span>
</span><span id="1-207">    <span class="k">else</span><span class="p">:</span>
</span><span id="1-208">        <span class="n">default_profiler_mode</span> <span class="o">=</span> <span class="n">ThreadScheduler</span><span class="o">.</span><span class="n">mode</span>
</span><span id="1-209">
</span><span id="1-210">    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;profiler_mode&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-211">        <span class="n">profiler_mode</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;profiler_mode&quot;</span><span class="p">]</span>
</span><span id="1-212">    <span class="k">else</span><span class="p">:</span>
</span><span id="1-213">        <span class="n">profiler_mode</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;_experiments&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;profiler_mode&quot;</span><span class="p">)</span>
</span><span id="1-214">        <span class="k">if</span> <span class="n">profiler_mode</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-215">            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="1-216">                <span class="s2">&quot;_experiments[&#39;profiler_mode&#39;] is deprecated. Please use the &quot;</span>
</span><span id="1-217">                <span class="s2">&quot;non-experimental profiler_mode option directly.&quot;</span>
</span><span id="1-218">            <span class="p">)</span>
</span><span id="1-219">        <span class="n">profiler_mode</span> <span class="o">=</span> <span class="n">profiler_mode</span> <span class="ow">or</span> <span class="n">default_profiler_mode</span>
</span><span id="1-220">
</span><span id="1-221">    <span class="k">if</span> <span class="p">(</span>
</span><span id="1-222">        <span class="n">profiler_mode</span> <span class="o">==</span> <span class="n">ThreadScheduler</span><span class="o">.</span><span class="n">mode</span>
</span><span id="1-223">        <span class="c1"># for legacy reasons, we&#39;ll keep supporting sleep mode for this scheduler</span>
</span><span id="1-224">        <span class="ow">or</span> <span class="n">profiler_mode</span> <span class="o">==</span> <span class="s2">&quot;sleep&quot;</span>
</span><span id="1-225">    <span class="p">):</span>
</span><span id="1-226">        <span class="n">_scheduler</span> <span class="o">=</span> <span class="n">ThreadScheduler</span><span class="p">(</span><span class="n">frequency</span><span class="o">=</span><span class="n">frequency</span><span class="p">)</span>
</span><span id="1-227">    <span class="k">elif</span> <span class="n">profiler_mode</span> <span class="o">==</span> <span class="n">GeventScheduler</span><span class="o">.</span><span class="n">mode</span><span class="p">:</span>
</span><span id="1-228">        <span class="n">_scheduler</span> <span class="o">=</span> <span class="n">GeventScheduler</span><span class="p">(</span><span class="n">frequency</span><span class="o">=</span><span class="n">frequency</span><span class="p">)</span>
</span><span id="1-229">    <span class="k">else</span><span class="p">:</span>
</span><span id="1-230">        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unknown profiler mode: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">profiler_mode</span><span class="p">))</span>
</span><span id="1-231">
</span><span id="1-232">    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
</span><span id="1-233">        <span class="s2">&quot;[Profiling] Setting up profiler in </span><span class="si">{mode}</span><span class="s2"> mode&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="n">_scheduler</span><span class="o">.</span><span class="n">mode</span><span class="p">)</span>
</span><span id="1-234">    <span class="p">)</span>
</span><span id="1-235">    <span class="n">_scheduler</span><span class="o">.</span><span class="n">setup</span><span class="p">()</span>
</span><span id="1-236">
</span><span id="1-237">    <span class="n">atexit</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">teardown_profiler</span><span class="p">)</span>
</span><span id="1-238">
</span><span id="1-239">    <span class="k">return</span> <span class="kc">True</span>
</span><span id="1-240">
</span><span id="1-241">
</span><span id="1-242"><span class="k">def</span> <span class="nf">teardown_profiler</span><span class="p">():</span>
</span><span id="1-243">    <span class="c1"># type: () -&gt; None</span>
</span><span id="1-244">
</span><span id="1-245">    <span class="k">global</span> <span class="n">_scheduler</span>
</span><span id="1-246">
</span><span id="1-247">    <span class="k">if</span> <span class="n">_scheduler</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-248">        <span class="n">_scheduler</span><span class="o">.</span><span class="n">teardown</span><span class="p">()</span>
</span><span id="1-249">
</span><span id="1-250">    <span class="n">_scheduler</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="1-251">
</span><span id="1-252">
</span><span id="1-253"><span class="c1"># We want to impose a stack depth limit so that samples aren&#39;t too large.</span>
</span><span id="1-254"><span class="n">MAX_STACK_DEPTH</span> <span class="o">=</span> <span class="mi">128</span>
</span><span id="1-255">
</span><span id="1-256">
</span><span id="1-257"><span class="k">def</span> <span class="nf">extract_stack</span><span class="p">(</span>
</span><span id="1-258">    <span class="n">raw_frame</span><span class="p">,</span>  <span class="c1"># type: Optional[FrameType]</span>
</span><span id="1-259">    <span class="n">cache</span><span class="p">,</span>  <span class="c1"># type: LRUCache</span>
</span><span id="1-260">    <span class="n">cwd</span><span class="p">,</span>  <span class="c1"># type: str</span>
</span><span id="1-261">    <span class="n">max_stack_depth</span><span class="o">=</span><span class="n">MAX_STACK_DEPTH</span><span class="p">,</span>  <span class="c1"># type: int</span>
</span><span id="1-262"><span class="p">):</span>
</span><span id="1-263">    <span class="c1"># type: (...) -&gt; ExtractedStack</span>
</span><span id="1-264"><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="1-265"><span class="sd">    Extracts the stack starting the specified frame. The extracted stack</span>
</span><span id="1-266"><span class="sd">    assumes the specified frame is the top of the stack, and works back</span>
</span><span id="1-267"><span class="sd">    to the bottom of the stack.</span>
</span><span id="1-268">
</span><span id="1-269"><span class="sd">    In the event that the stack is more than `MAX_STACK_DEPTH` frames deep,</span>
</span><span id="1-270"><span class="sd">    only the first `MAX_STACK_DEPTH` frames will be returned.</span>
</span><span id="1-271"><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="1-272">
</span><span id="1-273">    <span class="n">raw_frames</span> <span class="o">=</span> <span class="n">deque</span><span class="p">(</span><span class="n">maxlen</span><span class="o">=</span><span class="n">max_stack_depth</span><span class="p">)</span>  <span class="c1"># type: Deque[FrameType]</span>
</span><span id="1-274">
</span><span id="1-275">    <span class="k">while</span> <span class="n">raw_frame</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-276">        <span class="n">f_back</span> <span class="o">=</span> <span class="n">raw_frame</span><span class="o">.</span><span class="n">f_back</span>
</span><span id="1-277">        <span class="n">raw_frames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">raw_frame</span><span class="p">)</span>
</span><span id="1-278">        <span class="n">raw_frame</span> <span class="o">=</span> <span class="n">f_back</span>
</span><span id="1-279">
</span><span id="1-280">    <span class="n">frame_ids</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">frame_id</span><span class="p">(</span><span class="n">raw_frame</span><span class="p">)</span> <span class="k">for</span> <span class="n">raw_frame</span> <span class="ow">in</span> <span class="n">raw_frames</span><span class="p">)</span>
</span><span id="1-281">    <span class="n">frames</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="1-282">    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">fid</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">frame_ids</span><span class="p">):</span>
</span><span id="1-283">        <span class="n">frame</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">fid</span><span class="p">)</span>
</span><span id="1-284">        <span class="k">if</span> <span class="n">frame</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-285">            <span class="n">frame</span> <span class="o">=</span> <span class="n">extract_frame</span><span class="p">(</span><span class="n">fid</span><span class="p">,</span> <span class="n">raw_frames</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">cwd</span><span class="p">)</span>
</span><span id="1-286">            <span class="n">cache</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">fid</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>
</span><span id="1-287">        <span class="n">frames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
</span><span id="1-288">
</span><span id="1-289">    <span class="c1"># Instead of mapping the stack into frame ids and hashing</span>
</span><span id="1-290">    <span class="c1"># that as a tuple, we can directly hash the stack.</span>
</span><span id="1-291">    <span class="c1"># This saves us from having to generate yet another list.</span>
</span><span id="1-292">    <span class="c1"># Additionally, using the stack as the key directly is</span>
</span><span id="1-293">    <span class="c1"># costly because the stack can be large, so we pre-hash</span>
</span><span id="1-294">    <span class="c1"># the stack, and use the hash as the key as this will be</span>
</span><span id="1-295">    <span class="c1"># needed a few times to improve performance.</span>
</span><span id="1-296">    <span class="c1">#</span>
</span><span id="1-297">    <span class="c1"># To Reduce the likelihood of hash collisions, we include</span>
</span><span id="1-298">    <span class="c1"># the stack depth. This means that only stacks of the same</span>
</span><span id="1-299">    <span class="c1"># depth can suffer from hash collisions.</span>
</span><span id="1-300">    <span class="n">stack_id</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">raw_frames</span><span class="p">),</span> <span class="nb">hash</span><span class="p">(</span><span class="n">frame_ids</span><span class="p">)</span>
</span><span id="1-301">
</span><span id="1-302">    <span class="k">return</span> <span class="n">stack_id</span><span class="p">,</span> <span class="n">frame_ids</span><span class="p">,</span> <span class="n">frames</span>
</span><span id="1-303">
</span><span id="1-304">
</span><span id="1-305"><span class="k">def</span> <span class="nf">frame_id</span><span class="p">(</span><span class="n">raw_frame</span><span class="p">):</span>
</span><span id="1-306">    <span class="c1"># type: (FrameType) -&gt; FrameId</span>
</span><span id="1-307">    <span class="k">return</span> <span class="p">(</span><span class="n">raw_frame</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_filename</span><span class="p">,</span> <span class="n">raw_frame</span><span class="o">.</span><span class="n">f_lineno</span><span class="p">,</span> <span class="n">get_frame_name</span><span class="p">(</span><span class="n">raw_frame</span><span class="p">))</span>
</span><span id="1-308">
</span><span id="1-309">
</span><span id="1-310"><span class="k">def</span> <span class="nf">extract_frame</span><span class="p">(</span><span class="n">fid</span><span class="p">,</span> <span class="n">raw_frame</span><span class="p">,</span> <span class="n">cwd</span><span class="p">):</span>
</span><span id="1-311">    <span class="c1"># type: (FrameId, FrameType, str) -&gt; ProcessedFrame</span>
</span><span id="1-312">    <span class="n">abs_path</span> <span class="o">=</span> <span class="n">raw_frame</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_filename</span>
</span><span id="1-313">
</span><span id="1-314">    <span class="k">try</span><span class="p">:</span>
</span><span id="1-315">        <span class="n">module</span> <span class="o">=</span> <span class="n">raw_frame</span><span class="o">.</span><span class="n">f_globals</span><span class="p">[</span><span class="s2">&quot;__name__&quot;</span><span class="p">]</span>
</span><span id="1-316">    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
</span><span id="1-317">        <span class="n">module</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="1-318">
</span><span id="1-319">    <span class="c1"># namedtuples can be many times slower when initialing</span>
</span><span id="1-320">    <span class="c1"># and accessing attribute so we opt to use a tuple here instead</span>
</span><span id="1-321">    <span class="k">return</span> <span class="p">{</span>
</span><span id="1-322">        <span class="c1"># This originally was `os.path.abspath(abs_path)` but that had</span>
</span><span id="1-323">        <span class="c1"># a large performance overhead.</span>
</span><span id="1-324">        <span class="c1">#</span>
</span><span id="1-325">        <span class="c1"># According to docs, this is equivalent to</span>
</span><span id="1-326">        <span class="c1"># `os.path.normpath(os.path.join(os.getcwd(), path))`.</span>
</span><span id="1-327">        <span class="c1"># The `os.getcwd()` call is slow here, so we precompute it.</span>
</span><span id="1-328">        <span class="c1">#</span>
</span><span id="1-329">        <span class="c1"># Additionally, since we are using normalized path already,</span>
</span><span id="1-330">        <span class="c1"># we skip calling `os.path.normpath` entirely.</span>
</span><span id="1-331">        <span class="s2">&quot;abs_path&quot;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cwd</span><span class="p">,</span> <span class="n">abs_path</span><span class="p">),</span>
</span><span id="1-332">        <span class="s2">&quot;module&quot;</span><span class="p">:</span> <span class="n">module</span><span class="p">,</span>
</span><span id="1-333">        <span class="s2">&quot;filename&quot;</span><span class="p">:</span> <span class="n">filename_for_module</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">abs_path</span><span class="p">)</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-334">        <span class="s2">&quot;function&quot;</span><span class="p">:</span> <span class="n">fid</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
</span><span id="1-335">        <span class="s2">&quot;lineno&quot;</span><span class="p">:</span> <span class="n">raw_frame</span><span class="o">.</span><span class="n">f_lineno</span><span class="p">,</span>
</span><span id="1-336">    <span class="p">}</span>
</span><span id="1-337">
</span><span id="1-338">
</span><span id="1-339"><span class="k">if</span> <span class="n">PY311</span><span class="p">:</span>
</span><span id="1-340">
</span><span id="1-341">    <span class="k">def</span> <span class="nf">get_frame_name</span><span class="p">(</span><span class="n">frame</span><span class="p">):</span>
</span><span id="1-342">        <span class="c1"># type: (FrameType) -&gt; str</span>
</span><span id="1-343">        <span class="k">return</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_qualname</span>
</span><span id="1-344">
</span><span id="1-345"><span class="k">else</span><span class="p">:</span>
</span><span id="1-346">
</span><span id="1-347">    <span class="k">def</span> <span class="nf">get_frame_name</span><span class="p">(</span><span class="n">frame</span><span class="p">):</span>
</span><span id="1-348">        <span class="c1"># type: (FrameType) -&gt; str</span>
</span><span id="1-349">
</span><span id="1-350">        <span class="n">f_code</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_code</span>
</span><span id="1-351">        <span class="n">co_varnames</span> <span class="o">=</span> <span class="n">f_code</span><span class="o">.</span><span class="n">co_varnames</span>
</span><span id="1-352">
</span><span id="1-353">        <span class="c1"># co_name only contains the frame name.  If the frame was a method,</span>
</span><span id="1-354">        <span class="c1"># the class name will NOT be included.</span>
</span><span id="1-355">        <span class="n">name</span> <span class="o">=</span> <span class="n">f_code</span><span class="o">.</span><span class="n">co_name</span>
</span><span id="1-356">
</span><span id="1-357">        <span class="c1"># if it was a method, we can get the class name by inspecting</span>
</span><span id="1-358">        <span class="c1"># the f_locals for the `self` argument</span>
</span><span id="1-359">        <span class="k">try</span><span class="p">:</span>
</span><span id="1-360">            <span class="k">if</span> <span class="p">(</span>
</span><span id="1-361">                <span class="c1"># the co_varnames start with the frame&#39;s positional arguments</span>
</span><span id="1-362">                <span class="c1"># and we expect the first to be `self` if its an instance method</span>
</span><span id="1-363">                <span class="n">co_varnames</span>
</span><span id="1-364">                <span class="ow">and</span> <span class="n">co_varnames</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;self&quot;</span>
</span><span id="1-365">                <span class="ow">and</span> <span class="s2">&quot;self&quot;</span> <span class="ow">in</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_locals</span>
</span><span id="1-366">            <span class="p">):</span>
</span><span id="1-367">                <span class="k">for</span> <span class="bp">cls</span> <span class="ow">in</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_locals</span><span class="p">[</span><span class="s2">&quot;self&quot;</span><span class="p">]</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__mro__</span><span class="p">:</span>
</span><span id="1-368">                    <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">:</span>
</span><span id="1-369">                        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">.</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
</span><span id="1-370">        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
</span><span id="1-371">            <span class="k">pass</span>
</span><span id="1-372">
</span><span id="1-373">        <span class="c1"># if it was a class method, (decorated with `@classmethod`)</span>
</span><span id="1-374">        <span class="c1"># we can get the class name by inspecting the f_locals for the `cls` argument</span>
</span><span id="1-375">        <span class="k">try</span><span class="p">:</span>
</span><span id="1-376">            <span class="k">if</span> <span class="p">(</span>
</span><span id="1-377">                <span class="c1"># the co_varnames start with the frame&#39;s positional arguments</span>
</span><span id="1-378">                <span class="c1"># and we expect the first to be `cls` if its a class method</span>
</span><span id="1-379">                <span class="n">co_varnames</span>
</span><span id="1-380">                <span class="ow">and</span> <span class="n">co_varnames</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;cls&quot;</span>
</span><span id="1-381">                <span class="ow">and</span> <span class="s2">&quot;cls&quot;</span> <span class="ow">in</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_locals</span>
</span><span id="1-382">            <span class="p">):</span>
</span><span id="1-383">                <span class="k">for</span> <span class="bp">cls</span> <span class="ow">in</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_locals</span><span class="p">[</span><span class="s2">&quot;cls&quot;</span><span class="p">]</span><span class="o">.</span><span class="vm">__mro__</span><span class="p">:</span>
</span><span id="1-384">                    <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">:</span>
</span><span id="1-385">                        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">.</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
</span><span id="1-386">        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
</span><span id="1-387">            <span class="k">pass</span>
</span><span id="1-388">
</span><span id="1-389">        <span class="c1"># nothing we can do if it is a staticmethod (decorated with @staticmethod)</span>
</span><span id="1-390">
</span><span id="1-391">        <span class="c1"># we&#39;ve done all we can, time to give up and return what we have</span>
</span><span id="1-392">        <span class="k">return</span> <span class="n">name</span>
</span><span id="1-393">
</span><span id="1-394">
</span><span id="1-395"><span class="n">MAX_PROFILE_DURATION_NS</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mf">3e10</span><span class="p">)</span>  <span class="c1"># 30 seconds</span>
</span><span id="1-396">
</span><span id="1-397">
</span><span id="1-398"><span class="k">def</span> <span class="nf">get_current_thread_id</span><span class="p">(</span><span class="n">thread</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="1-399">    <span class="c1"># type: (Optional[threading.Thread]) -&gt; Optional[int]</span>
</span><span id="1-400"><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="1-401"><span class="sd">    Try to get the id of the current thread, with various fall backs.</span>
</span><span id="1-402"><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="1-403">
</span><span id="1-404">    <span class="c1"># if a thread is specified, that takes priority</span>
</span><span id="1-405">    <span class="k">if</span> <span class="n">thread</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-406">        <span class="k">try</span><span class="p">:</span>
</span><span id="1-407">            <span class="n">thread_id</span> <span class="o">=</span> <span class="n">thread</span><span class="o">.</span><span class="n">ident</span>
</span><span id="1-408">            <span class="k">if</span> <span class="n">thread_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-409">                <span class="k">return</span> <span class="n">thread_id</span>
</span><span id="1-410">        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
</span><span id="1-411">            <span class="k">pass</span>
</span><span id="1-412">
</span><span id="1-413">    <span class="c1"># if the app is using gevent, we should look at the gevent hub first</span>
</span><span id="1-414">    <span class="c1"># as the id there differs from what the threading module reports</span>
</span><span id="1-415">    <span class="k">if</span> <span class="n">is_gevent</span><span class="p">():</span>
</span><span id="1-416">        <span class="n">gevent_hub</span> <span class="o">=</span> <span class="n">get_gevent_hub</span><span class="p">()</span>
</span><span id="1-417">        <span class="k">if</span> <span class="n">gevent_hub</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-418">            <span class="k">try</span><span class="p">:</span>
</span><span id="1-419">                <span class="c1"># this is undocumented, so wrap it in try except to be safe</span>
</span><span id="1-420">                <span class="k">return</span> <span class="n">gevent_hub</span><span class="o">.</span><span class="n">thread_ident</span>
</span><span id="1-421">            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
</span><span id="1-422">                <span class="k">pass</span>
</span><span id="1-423">
</span><span id="1-424">    <span class="c1"># use the current thread&#39;s id if possible</span>
</span><span id="1-425">    <span class="k">try</span><span class="p">:</span>
</span><span id="1-426">        <span class="n">current_thread_id</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">current_thread</span><span class="p">()</span><span class="o">.</span><span class="n">ident</span>
</span><span id="1-427">        <span class="k">if</span> <span class="n">current_thread_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-428">            <span class="k">return</span> <span class="n">current_thread_id</span>
</span><span id="1-429">    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
</span><span id="1-430">        <span class="k">pass</span>
</span><span id="1-431">
</span><span id="1-432">    <span class="c1"># if we can&#39;t get the current thread id, fall back to the main thread id</span>
</span><span id="1-433">    <span class="k">try</span><span class="p">:</span>
</span><span id="1-434">        <span class="n">main_thread_id</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">main_thread</span><span class="p">()</span><span class="o">.</span><span class="n">ident</span>
</span><span id="1-435">        <span class="k">if</span> <span class="n">main_thread_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-436">            <span class="k">return</span> <span class="n">main_thread_id</span>
</span><span id="1-437">    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
</span><span id="1-438">        <span class="k">pass</span>
</span><span id="1-439">
</span><span id="1-440">    <span class="c1"># we&#39;ve tried everything, time to give up</span>
</span><span id="1-441">    <span class="k">return</span> <span class="kc">None</span>
</span><span id="1-442">
</span><span id="1-443">
<div class="viewcode-block" id="Profile">
<a class="viewcode-back" href="../../apidocs.html#sentry_sdk.profiler.Profile">[docs]</a>
</span><span id="1-444"><span class="k">class</span> <span class="nc">Profile</span><span class="p">:</span>
</span><span id="1-445">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span><span id="1-446">        <span class="bp">self</span><span class="p">,</span>
</span><span id="1-447">        <span class="n">transaction</span><span class="p">,</span>  <span class="c1"># type: sentry_sdk.tracing.Transaction</span>
</span><span id="1-448">        <span class="n">hub</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="c1"># type: Optional[sentry_sdk.Hub]</span>
</span><span id="1-449">        <span class="n">scheduler</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="c1"># type: Optional[Scheduler]</span>
</span><span id="1-450">    <span class="p">):</span>
</span><span id="1-451">        <span class="c1"># type: (...) -&gt; None</span>
</span><span id="1-452">        <span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span> <span class="o">=</span> <span class="n">_scheduler</span> <span class="k">if</span> <span class="n">scheduler</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">scheduler</span>
</span><span id="1-453">        <span class="bp">self</span><span class="o">.</span><span class="n">hub</span> <span class="o">=</span> <span class="n">hub</span>
</span><span id="1-454">
</span><span id="1-455">        <span class="bp">self</span><span class="o">.</span><span class="n">event_id</span> <span class="o">=</span> <span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span><span class="o">.</span><span class="n">hex</span>  <span class="c1"># type: str</span>
</span><span id="1-456">
</span><span id="1-457">        <span class="c1"># Here, we assume that the sampling decision on the transaction has been finalized.</span>
</span><span id="1-458">        <span class="c1">#</span>
</span><span id="1-459">        <span class="c1"># We cannot keep a reference to the transaction around here because it&#39;ll create</span>
</span><span id="1-460">        <span class="c1"># a reference cycle. So we opt to pull out just the necessary attributes.</span>
</span><span id="1-461">        <span class="bp">self</span><span class="o">.</span><span class="n">sampled</span> <span class="o">=</span> <span class="n">transaction</span><span class="o">.</span><span class="n">sampled</span>  <span class="c1"># type: Optional[bool]</span>
</span><span id="1-462">
</span><span id="1-463">        <span class="c1"># Various framework integrations are capable of overwriting the active thread id.</span>
</span><span id="1-464">        <span class="c1"># If it is set to `None` at the end of the profile, we fall back to the default.</span>
</span><span id="1-465">        <span class="bp">self</span><span class="o">.</span><span class="n">_default_active_thread_id</span> <span class="o">=</span> <span class="n">get_current_thread_id</span><span class="p">()</span> <span class="ow">or</span> <span class="mi">0</span>  <span class="c1"># type: int</span>
</span><span id="1-466">        <span class="bp">self</span><span class="o">.</span><span class="n">active_thread_id</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># type: Optional[int]</span>
</span><span id="1-467">
</span><span id="1-468">        <span class="k">try</span><span class="p">:</span>
</span><span id="1-469">            <span class="bp">self</span><span class="o">.</span><span class="n">start_ns</span> <span class="o">=</span> <span class="n">transaction</span><span class="o">.</span><span class="n">_start_timestamp_monotonic_ns</span>  <span class="c1"># type: int</span>
</span><span id="1-470">        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
</span><span id="1-471">            <span class="bp">self</span><span class="o">.</span><span class="n">start_ns</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="1-472">
</span><span id="1-473">        <span class="bp">self</span><span class="o">.</span><span class="n">stop_ns</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># type: int</span>
</span><span id="1-474">        <span class="bp">self</span><span class="o">.</span><span class="n">active</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># type: bool</span>
</span><span id="1-475">
</span><span id="1-476">        <span class="bp">self</span><span class="o">.</span><span class="n">indexed_frames</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># type: Dict[FrameId, int]</span>
</span><span id="1-477">        <span class="bp">self</span><span class="o">.</span><span class="n">indexed_stacks</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># type: Dict[StackId, int]</span>
</span><span id="1-478">        <span class="bp">self</span><span class="o">.</span><span class="n">frames</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># type: List[ProcessedFrame]</span>
</span><span id="1-479">        <span class="bp">self</span><span class="o">.</span><span class="n">stacks</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># type: List[ProcessedStack]</span>
</span><span id="1-480">        <span class="bp">self</span><span class="o">.</span><span class="n">samples</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># type: List[ProcessedSample]</span>
</span><span id="1-481">
</span><span id="1-482">        <span class="bp">self</span><span class="o">.</span><span class="n">unique_samples</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="1-483">
</span><span id="1-484">        <span class="n">transaction</span><span class="o">.</span><span class="n">_profile</span> <span class="o">=</span> <span class="bp">self</span>
</span><span id="1-485">
</span><span id="1-486">    <span class="k">def</span> <span class="nf">update_active_thread_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="1-487">        <span class="c1"># type: () -&gt; None</span>
</span><span id="1-488">        <span class="bp">self</span><span class="o">.</span><span class="n">active_thread_id</span> <span class="o">=</span> <span class="n">get_current_thread_id</span><span class="p">()</span>
</span><span id="1-489">        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
</span><span id="1-490">            <span class="s2">&quot;[Profiling] updating active thread id to </span><span class="si">{tid}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="1-491">                <span class="n">tid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">active_thread_id</span>
</span><span id="1-492">            <span class="p">)</span>
</span><span id="1-493">        <span class="p">)</span>
</span><span id="1-494">
</span><span id="1-495">    <span class="k">def</span> <span class="nf">_set_initial_sampling_decision</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sampling_context</span><span class="p">):</span>
</span><span id="1-496">        <span class="c1"># type: (SamplingContext) -&gt; None</span>
</span><span id="1-497"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="1-498"><span class="sd">        Sets the profile&#39;s sampling decision according to the following</span>
</span><span id="1-499"><span class="sd">        precedence rules:</span>
</span><span id="1-500">
</span><span id="1-501"><span class="sd">        1. If the transaction to be profiled is not sampled, that decision</span>
</span><span id="1-502"><span class="sd">        will be used, regardless of anything else.</span>
</span><span id="1-503">
</span><span id="1-504"><span class="sd">        2. Use `profiles_sample_rate` to decide.</span>
</span><span id="1-505"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="1-506">
</span><span id="1-507">        <span class="c1"># The corresponding transaction was not sampled,</span>
</span><span id="1-508">        <span class="c1"># so don&#39;t generate a profile for it.</span>
</span><span id="1-509">        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">sampled</span><span class="p">:</span>
</span><span id="1-510">            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
</span><span id="1-511">                <span class="s2">&quot;[Profiling] Discarding profile because transaction is discarded.&quot;</span>
</span><span id="1-512">            <span class="p">)</span>
</span><span id="1-513">            <span class="bp">self</span><span class="o">.</span><span class="n">sampled</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="1-514">            <span class="k">return</span>
</span><span id="1-515">
</span><span id="1-516">        <span class="c1"># The profiler hasn&#39;t been properly initialized.</span>
</span><span id="1-517">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-518">            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
</span><span id="1-519">                <span class="s2">&quot;[Profiling] Discarding profile because profiler was not started.&quot;</span>
</span><span id="1-520">            <span class="p">)</span>
</span><span id="1-521">            <span class="bp">self</span><span class="o">.</span><span class="n">sampled</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="1-522">            <span class="k">return</span>
</span><span id="1-523">
</span><span id="1-524">        <span class="n">client</span> <span class="o">=</span> <span class="n">sentry_sdk</span><span class="o">.</span><span class="n">Scope</span><span class="o">.</span><span class="n">get_client</span><span class="p">()</span>
</span><span id="1-525">        <span class="k">if</span> <span class="ow">not</span> <span class="n">client</span><span class="o">.</span><span class="n">is_active</span><span class="p">():</span>
</span><span id="1-526">            <span class="bp">self</span><span class="o">.</span><span class="n">sampled</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="1-527">            <span class="k">return</span>
</span><span id="1-528">
</span><span id="1-529">        <span class="n">options</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">options</span>
</span><span id="1-530">
</span><span id="1-531">        <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;profiles_sampler&quot;</span><span class="p">)):</span>
</span><span id="1-532">            <span class="n">sample_rate</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;profiles_sampler&quot;</span><span class="p">](</span><span class="n">sampling_context</span><span class="p">)</span>
</span><span id="1-533">        <span class="k">elif</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;profiles_sample_rate&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-534">            <span class="n">sample_rate</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;profiles_sample_rate&quot;</span><span class="p">]</span>
</span><span id="1-535">        <span class="k">else</span><span class="p">:</span>
</span><span id="1-536">            <span class="n">sample_rate</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;_experiments&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;profiles_sample_rate&quot;</span><span class="p">)</span>
</span><span id="1-537">
</span><span id="1-538">        <span class="c1"># The profiles_sample_rate option was not set, so profiling</span>
</span><span id="1-539">        <span class="c1"># was never enabled.</span>
</span><span id="1-540">        <span class="k">if</span> <span class="n">sample_rate</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-541">            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
</span><span id="1-542">                <span class="s2">&quot;[Profiling] Discarding profile because profiling was not enabled.&quot;</span>
</span><span id="1-543">            <span class="p">)</span>
</span><span id="1-544">            <span class="bp">self</span><span class="o">.</span><span class="n">sampled</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="1-545">            <span class="k">return</span>
</span><span id="1-546">
</span><span id="1-547">        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_valid_sample_rate</span><span class="p">(</span><span class="n">sample_rate</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="s2">&quot;Profiling&quot;</span><span class="p">):</span>
</span><span id="1-548">            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="1-549">                <span class="s2">&quot;[Profiling] Discarding profile because of invalid sample rate.&quot;</span>
</span><span id="1-550">            <span class="p">)</span>
</span><span id="1-551">            <span class="bp">self</span><span class="o">.</span><span class="n">sampled</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="1-552">            <span class="k">return</span>
</span><span id="1-553">
</span><span id="1-554">        <span class="c1"># Now we roll the dice. random.random is inclusive of 0, but not of 1,</span>
</span><span id="1-555">        <span class="c1"># so strict &lt; is safe here. In case sample_rate is a boolean, cast it</span>
</span><span id="1-556">        <span class="c1"># to a float (True becomes 1.0 and False becomes 0.0)</span>
</span><span id="1-557">        <span class="bp">self</span><span class="o">.</span><span class="n">sampled</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&lt;</span> <span class="nb">float</span><span class="p">(</span><span class="n">sample_rate</span><span class="p">)</span>
</span><span id="1-558">
</span><span id="1-559">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sampled</span><span class="p">:</span>
</span><span id="1-560">            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;[Profiling] Initializing profile&quot;</span><span class="p">)</span>
</span><span id="1-561">        <span class="k">else</span><span class="p">:</span>
</span><span id="1-562">            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
</span><span id="1-563">                <span class="s2">&quot;[Profiling] Discarding profile because it&#39;s not included in the random sample (sample rate = </span><span class="si">{sample_rate}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="1-564">                    <span class="n">sample_rate</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">sample_rate</span><span class="p">)</span>
</span><span id="1-565">                <span class="p">)</span>
</span><span id="1-566">            <span class="p">)</span>
</span><span id="1-567">
</span><span id="1-568">    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="1-569">        <span class="c1"># type: () -&gt; None</span>
</span><span id="1-570">        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">sampled</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">active</span><span class="p">:</span>
</span><span id="1-571">            <span class="k">return</span>
</span><span id="1-572">
</span><span id="1-573">        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span><span class="p">,</span> <span class="s2">&quot;No scheduler specified&quot;</span>
</span><span id="1-574">        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;[Profiling] Starting profile&quot;</span><span class="p">)</span>
</span><span id="1-575">        <span class="bp">self</span><span class="o">.</span><span class="n">active</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="1-576">        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_ns</span><span class="p">:</span>
</span><span id="1-577">            <span class="bp">self</span><span class="o">.</span><span class="n">start_ns</span> <span class="o">=</span> <span class="n">nanosecond_time</span><span class="p">()</span>
</span><span id="1-578">        <span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span><span class="o">.</span><span class="n">start_profiling</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span id="1-579">
</span><span id="1-580">    <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="1-581">        <span class="c1"># type: () -&gt; None</span>
</span><span id="1-582">        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">sampled</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">active</span><span class="p">:</span>
</span><span id="1-583">            <span class="k">return</span>
</span><span id="1-584">
</span><span id="1-585">        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span><span class="p">,</span> <span class="s2">&quot;No scheduler specified&quot;</span>
</span><span id="1-586">        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;[Profiling] Stopping profile&quot;</span><span class="p">)</span>
</span><span id="1-587">        <span class="bp">self</span><span class="o">.</span><span class="n">active</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="1-588">        <span class="bp">self</span><span class="o">.</span><span class="n">stop_ns</span> <span class="o">=</span> <span class="n">nanosecond_time</span><span class="p">()</span>
</span><span id="1-589">
</span><span id="1-590">    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="1-591">        <span class="c1"># type: () -&gt; Profile</span>
</span><span id="1-592">        <span class="n">scope</span> <span class="o">=</span> <span class="n">sentry_sdk</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">Scope</span><span class="o">.</span><span class="n">get_isolation_scope</span><span class="p">()</span>
</span><span id="1-593">        <span class="n">old_profile</span> <span class="o">=</span> <span class="n">scope</span><span class="o">.</span><span class="n">profile</span>
</span><span id="1-594">        <span class="n">scope</span><span class="o">.</span><span class="n">profile</span> <span class="o">=</span> <span class="bp">self</span>
</span><span id="1-595">
</span><span id="1-596">        <span class="bp">self</span><span class="o">.</span><span class="n">_context_manager_state</span> <span class="o">=</span> <span class="p">(</span><span class="n">scope</span><span class="p">,</span> <span class="n">old_profile</span><span class="p">)</span>
</span><span id="1-597">
</span><span id="1-598">        <span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</span><span id="1-599">
</span><span id="1-600">        <span class="k">return</span> <span class="bp">self</span>
</span><span id="1-601">
</span><span id="1-602">    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ty</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">tb</span><span class="p">):</span>
</span><span id="1-603">        <span class="c1"># type: (Optional[Any], Optional[Any], Optional[Any]) -&gt; None</span>
</span><span id="1-604">        <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
</span><span id="1-605">
</span><span id="1-606">        <span class="n">scope</span><span class="p">,</span> <span class="n">old_profile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_context_manager_state</span>
</span><span id="1-607">        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_context_manager_state</span>
</span><span id="1-608">
</span><span id="1-609">        <span class="n">scope</span><span class="o">.</span><span class="n">profile</span> <span class="o">=</span> <span class="n">old_profile</span>
</span><span id="1-610">
</span><span id="1-611">    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">sample</span><span class="p">):</span>
</span><span id="1-612">        <span class="c1"># type: (int, ExtractedSample) -&gt; None</span>
</span><span id="1-613">        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">active</span><span class="p">:</span>
</span><span id="1-614">            <span class="k">return</span>
</span><span id="1-615">
</span><span id="1-616">        <span class="k">if</span> <span class="n">ts</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_ns</span><span class="p">:</span>
</span><span id="1-617">            <span class="k">return</span>
</span><span id="1-618">
</span><span id="1-619">        <span class="n">offset</span> <span class="o">=</span> <span class="n">ts</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_ns</span>
</span><span id="1-620">        <span class="k">if</span> <span class="n">offset</span> <span class="o">&gt;</span> <span class="n">MAX_PROFILE_DURATION_NS</span><span class="p">:</span>
</span><span id="1-621">            <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
</span><span id="1-622">            <span class="k">return</span>
</span><span id="1-623">
</span><span id="1-624">        <span class="bp">self</span><span class="o">.</span><span class="n">unique_samples</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="1-625">
</span><span id="1-626">        <span class="n">elapsed_since_start_ns</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span>
</span><span id="1-627">
</span><span id="1-628">        <span class="k">for</span> <span class="n">tid</span><span class="p">,</span> <span class="p">(</span><span class="n">stack_id</span><span class="p">,</span> <span class="n">frame_ids</span><span class="p">,</span> <span class="n">frames</span><span class="p">)</span> <span class="ow">in</span> <span class="n">sample</span><span class="p">:</span>
</span><span id="1-629">            <span class="k">try</span><span class="p">:</span>
</span><span id="1-630">                <span class="c1"># Check if the stack is indexed first, this lets us skip</span>
</span><span id="1-631">                <span class="c1"># indexing frames if it&#39;s not necessary</span>
</span><span id="1-632">                <span class="k">if</span> <span class="n">stack_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">indexed_stacks</span><span class="p">:</span>
</span><span id="1-633">                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">frame_id</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">frame_ids</span><span class="p">):</span>
</span><span id="1-634">                        <span class="k">if</span> <span class="n">frame_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">indexed_frames</span><span class="p">:</span>
</span><span id="1-635">                            <span class="bp">self</span><span class="o">.</span><span class="n">indexed_frames</span><span class="p">[</span><span class="n">frame_id</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">indexed_frames</span><span class="p">)</span>
</span><span id="1-636">                            <span class="bp">self</span><span class="o">.</span><span class="n">frames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">frames</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</span><span id="1-637">
</span><span id="1-638">                    <span class="bp">self</span><span class="o">.</span><span class="n">indexed_stacks</span><span class="p">[</span><span class="n">stack_id</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">indexed_stacks</span><span class="p">)</span>
</span><span id="1-639">                    <span class="bp">self</span><span class="o">.</span><span class="n">stacks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="1-640">                        <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">indexed_frames</span><span class="p">[</span><span class="n">frame_id</span><span class="p">]</span> <span class="k">for</span> <span class="n">frame_id</span> <span class="ow">in</span> <span class="n">frame_ids</span><span class="p">]</span>
</span><span id="1-641">                    <span class="p">)</span>
</span><span id="1-642">
</span><span id="1-643">                <span class="bp">self</span><span class="o">.</span><span class="n">samples</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="1-644">                    <span class="p">{</span>
</span><span id="1-645">                        <span class="s2">&quot;elapsed_since_start_ns&quot;</span><span class="p">:</span> <span class="n">elapsed_since_start_ns</span><span class="p">,</span>
</span><span id="1-646">                        <span class="s2">&quot;thread_id&quot;</span><span class="p">:</span> <span class="n">tid</span><span class="p">,</span>
</span><span id="1-647">                        <span class="s2">&quot;stack_id&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">indexed_stacks</span><span class="p">[</span><span class="n">stack_id</span><span class="p">],</span>
</span><span id="1-648">                    <span class="p">}</span>
</span><span id="1-649">                <span class="p">)</span>
</span><span id="1-650">            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
</span><span id="1-651">                <span class="c1"># For some reason, the frame we get doesn&#39;t have certain attributes.</span>
</span><span id="1-652">                <span class="c1"># When this happens, we abandon the current sample as it&#39;s bad.</span>
</span><span id="1-653">                <span class="n">capture_internal_exception</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">())</span>
</span><span id="1-654">
</span><span id="1-655">    <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="1-656">        <span class="c1"># type: () -&gt; ProcessedProfile</span>
</span><span id="1-657">
</span><span id="1-658">        <span class="c1"># This collects the thread metadata at the end of a profile. Doing it</span>
</span><span id="1-659">        <span class="c1"># this way means that any threads that terminate before the profile ends</span>
</span><span id="1-660">        <span class="c1"># will not have any metadata associated with it.</span>
</span><span id="1-661">        <span class="n">thread_metadata</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="1-662">            <span class="nb">str</span><span class="p">(</span><span class="n">thread</span><span class="o">.</span><span class="n">ident</span><span class="p">):</span> <span class="p">{</span>
</span><span id="1-663">                <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">thread</span><span class="o">.</span><span class="n">name</span><span class="p">),</span>
</span><span id="1-664">            <span class="p">}</span>
</span><span id="1-665">            <span class="k">for</span> <span class="n">thread</span> <span class="ow">in</span> <span class="n">threading</span><span class="o">.</span><span class="n">enumerate</span><span class="p">()</span>
</span><span id="1-666">        <span class="p">}</span>  <span class="c1"># type: Dict[str, ProcessedThreadMetadata]</span>
</span><span id="1-667">
</span><span id="1-668">        <span class="k">return</span> <span class="p">{</span>
</span><span id="1-669">            <span class="s2">&quot;frames&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">frames</span><span class="p">,</span>
</span><span id="1-670">            <span class="s2">&quot;stacks&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">stacks</span><span class="p">,</span>
</span><span id="1-671">            <span class="s2">&quot;samples&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">samples</span><span class="p">,</span>
</span><span id="1-672">            <span class="s2">&quot;thread_metadata&quot;</span><span class="p">:</span> <span class="n">thread_metadata</span><span class="p">,</span>
</span><span id="1-673">        <span class="p">}</span>
</span><span id="1-674">
</span><span id="1-675">    <span class="k">def</span> <span class="nf">to_json</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event_opt</span><span class="p">,</span> <span class="n">options</span><span class="p">):</span>
</span><span id="1-676">        <span class="c1"># type: (Any, Dict[str, Any], Dict[str, Any]) -&gt; Dict[str, Any]</span>
</span><span id="1-677">        <span class="n">profile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="p">()</span>
</span><span id="1-678">
</span><span id="1-679">        <span class="n">set_in_app_in_frames</span><span class="p">(</span>
</span><span id="1-680">            <span class="n">profile</span><span class="p">[</span><span class="s2">&quot;frames&quot;</span><span class="p">],</span>
</span><span id="1-681">            <span class="n">options</span><span class="p">[</span><span class="s2">&quot;in_app_exclude&quot;</span><span class="p">],</span>
</span><span id="1-682">            <span class="n">options</span><span class="p">[</span><span class="s2">&quot;in_app_include&quot;</span><span class="p">],</span>
</span><span id="1-683">            <span class="n">options</span><span class="p">[</span><span class="s2">&quot;project_root&quot;</span><span class="p">],</span>
</span><span id="1-684">        <span class="p">)</span>
</span><span id="1-685">
</span><span id="1-686">        <span class="k">return</span> <span class="p">{</span>
</span><span id="1-687">            <span class="s2">&quot;environment&quot;</span><span class="p">:</span> <span class="n">event_opt</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;environment&quot;</span><span class="p">),</span>
</span><span id="1-688">            <span class="s2">&quot;event_id&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">event_id</span><span class="p">,</span>
</span><span id="1-689">            <span class="s2">&quot;platform&quot;</span><span class="p">:</span> <span class="s2">&quot;python&quot;</span><span class="p">,</span>
</span><span id="1-690">            <span class="s2">&quot;profile&quot;</span><span class="p">:</span> <span class="n">profile</span><span class="p">,</span>
</span><span id="1-691">            <span class="s2">&quot;release&quot;</span><span class="p">:</span> <span class="n">event_opt</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;release&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
</span><span id="1-692">            <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">event_opt</span><span class="p">[</span><span class="s2">&quot;start_timestamp&quot;</span><span class="p">],</span>
</span><span id="1-693">            <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span>
</span><span id="1-694">            <span class="s2">&quot;device&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="1-695">                <span class="s2">&quot;architecture&quot;</span><span class="p">:</span> <span class="n">platform</span><span class="o">.</span><span class="n">machine</span><span class="p">(),</span>
</span><span id="1-696">            <span class="p">},</span>
</span><span id="1-697">            <span class="s2">&quot;os&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="1-698">                <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">platform</span><span class="o">.</span><span class="n">system</span><span class="p">(),</span>
</span><span id="1-699">                <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="n">platform</span><span class="o">.</span><span class="n">release</span><span class="p">(),</span>
</span><span id="1-700">            <span class="p">},</span>
</span><span id="1-701">            <span class="s2">&quot;runtime&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="1-702">                <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">platform</span><span class="o">.</span><span class="n">python_implementation</span><span class="p">(),</span>
</span><span id="1-703">                <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="n">platform</span><span class="o">.</span><span class="n">python_version</span><span class="p">(),</span>
</span><span id="1-704">            <span class="p">},</span>
</span><span id="1-705">            <span class="s2">&quot;transactions&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span id="1-706">                <span class="p">{</span>
</span><span id="1-707">                    <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">event_opt</span><span class="p">[</span><span class="s2">&quot;event_id&quot;</span><span class="p">],</span>
</span><span id="1-708">                    <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">event_opt</span><span class="p">[</span><span class="s2">&quot;transaction&quot;</span><span class="p">],</span>
</span><span id="1-709">                    <span class="c1"># we start the transaction before the profile and this is</span>
</span><span id="1-710">                    <span class="c1"># the transaction start time relative to the profile, so we</span>
</span><span id="1-711">                    <span class="c1"># hardcode it to 0 until we can start the profile before</span>
</span><span id="1-712">                    <span class="s2">&quot;relative_start_ns&quot;</span><span class="p">:</span> <span class="s2">&quot;0&quot;</span><span class="p">,</span>
</span><span id="1-713">                    <span class="c1"># use the duration of the profile instead of the transaction</span>
</span><span id="1-714">                    <span class="c1"># because we end the transaction after the profile</span>
</span><span id="1-715">                    <span class="s2">&quot;relative_end_ns&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stop_ns</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_ns</span><span class="p">),</span>
</span><span id="1-716">                    <span class="s2">&quot;trace_id&quot;</span><span class="p">:</span> <span class="n">event_opt</span><span class="p">[</span><span class="s2">&quot;contexts&quot;</span><span class="p">][</span><span class="s2">&quot;trace&quot;</span><span class="p">][</span><span class="s2">&quot;trace_id&quot;</span><span class="p">],</span>
</span><span id="1-717">                    <span class="s2">&quot;active_thread_id&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span>
</span><span id="1-718">                        <span class="bp">self</span><span class="o">.</span><span class="n">_default_active_thread_id</span>
</span><span id="1-719">                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">active_thread_id</span> <span class="ow">is</span> <span class="kc">None</span>
</span><span id="1-720">                        <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">active_thread_id</span>
</span><span id="1-721">                    <span class="p">),</span>
</span><span id="1-722">                <span class="p">}</span>
</span><span id="1-723">            <span class="p">],</span>
</span><span id="1-724">        <span class="p">}</span>
</span><span id="1-725">
</span><span id="1-726">    <span class="k">def</span> <span class="nf">valid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="1-727">        <span class="c1"># type: () -&gt; bool</span>
</span><span id="1-728">        <span class="n">client</span> <span class="o">=</span> <span class="n">sentry_sdk</span><span class="o">.</span><span class="n">Scope</span><span class="o">.</span><span class="n">get_client</span><span class="p">()</span>
</span><span id="1-729">        <span class="k">if</span> <span class="ow">not</span> <span class="n">client</span><span class="o">.</span><span class="n">is_active</span><span class="p">():</span>
</span><span id="1-730">            <span class="k">return</span> <span class="kc">False</span>
</span><span id="1-731">
</span><span id="1-732">        <span class="k">if</span> <span class="ow">not</span> <span class="n">has_profiling_enabled</span><span class="p">(</span><span class="n">client</span><span class="o">.</span><span class="n">options</span><span class="p">):</span>
</span><span id="1-733">            <span class="k">return</span> <span class="kc">False</span>
</span><span id="1-734">
</span><span id="1-735">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sampled</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">sampled</span><span class="p">:</span>
</span><span id="1-736">            <span class="k">if</span> <span class="n">client</span><span class="o">.</span><span class="n">transport</span><span class="p">:</span>
</span><span id="1-737">                <span class="n">client</span><span class="o">.</span><span class="n">transport</span><span class="o">.</span><span class="n">record_lost_event</span><span class="p">(</span>
</span><span id="1-738">                    <span class="s2">&quot;sample_rate&quot;</span><span class="p">,</span> <span class="n">data_category</span><span class="o">=</span><span class="s2">&quot;profile&quot;</span>
</span><span id="1-739">                <span class="p">)</span>
</span><span id="1-740">            <span class="k">return</span> <span class="kc">False</span>
</span><span id="1-741">
</span><span id="1-742">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unique_samples</span> <span class="o">&lt;</span> <span class="n">PROFILE_MINIMUM_SAMPLES</span><span class="p">:</span>
</span><span id="1-743">            <span class="k">if</span> <span class="n">client</span><span class="o">.</span><span class="n">transport</span><span class="p">:</span>
</span><span id="1-744">                <span class="n">client</span><span class="o">.</span><span class="n">transport</span><span class="o">.</span><span class="n">record_lost_event</span><span class="p">(</span>
</span><span id="1-745">                    <span class="s2">&quot;insufficient_data&quot;</span><span class="p">,</span> <span class="n">data_category</span><span class="o">=</span><span class="s2">&quot;profile&quot;</span>
</span><span id="1-746">                <span class="p">)</span>
</span><span id="1-747">            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;[Profiling] Discarding profile because insufficient samples.&quot;</span><span class="p">)</span>
</span><span id="1-748">            <span class="k">return</span> <span class="kc">False</span>
</span><span id="1-749">
</span><span id="1-750">        <span class="k">return</span> <span class="kc">True</span></div>

</span><span id="1-751">
</span><span id="1-752">
</span><span id="1-753"><span class="k">class</span> <span class="nc">Scheduler</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
</span><span id="1-754">    <span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;unknown&quot;</span>  <span class="c1"># type: ProfilerMode</span>
</span><span id="1-755">
</span><span id="1-756">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frequency</span><span class="p">):</span>
</span><span id="1-757">        <span class="c1"># type: (int) -&gt; None</span>
</span><span id="1-758">        <span class="bp">self</span><span class="o">.</span><span class="n">interval</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">frequency</span>
</span><span id="1-759">
</span><span id="1-760">        <span class="bp">self</span><span class="o">.</span><span class="n">sampler</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_sampler</span><span class="p">()</span>
</span><span id="1-761">
</span><span id="1-762">        <span class="c1"># cap the number of new profiles at any time so it does not grow infinitely</span>
</span><span id="1-763">        <span class="bp">self</span><span class="o">.</span><span class="n">new_profiles</span> <span class="o">=</span> <span class="n">deque</span><span class="p">(</span><span class="n">maxlen</span><span class="o">=</span><span class="mi">128</span><span class="p">)</span>  <span class="c1"># type: Deque[Profile]</span>
</span><span id="1-764">        <span class="bp">self</span><span class="o">.</span><span class="n">active_profiles</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>  <span class="c1"># type: Set[Profile]</span>
</span><span id="1-765">
</span><span id="1-766">    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="1-767">        <span class="c1"># type: () -&gt; Scheduler</span>
</span><span id="1-768">        <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="p">()</span>
</span><span id="1-769">        <span class="k">return</span> <span class="bp">self</span>
</span><span id="1-770">
</span><span id="1-771">    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ty</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">tb</span><span class="p">):</span>
</span><span id="1-772">        <span class="c1"># type: (Optional[Any], Optional[Any], Optional[Any]) -&gt; None</span>
</span><span id="1-773">        <span class="bp">self</span><span class="o">.</span><span class="n">teardown</span><span class="p">()</span>
</span><span id="1-774">
</span><span id="1-775">    <span class="nd">@abstractmethod</span>
</span><span id="1-776">    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="1-777">        <span class="c1"># type: () -&gt; None</span>
</span><span id="1-778">        <span class="k">pass</span>
</span><span id="1-779">
</span><span id="1-780">    <span class="nd">@abstractmethod</span>
</span><span id="1-781">    <span class="k">def</span> <span class="nf">teardown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="1-782">        <span class="c1"># type: () -&gt; None</span>
</span><span id="1-783">        <span class="k">pass</span>
</span><span id="1-784">
</span><span id="1-785">    <span class="k">def</span> <span class="nf">ensure_running</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="1-786">        <span class="c1"># type: () -&gt; None</span>
</span><span id="1-787"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="1-788"><span class="sd">        Ensure the scheduler is running. By default, this method is a no-op.</span>
</span><span id="1-789"><span class="sd">        The method should be overridden by any implementation for which it is</span>
</span><span id="1-790"><span class="sd">        relevant.</span>
</span><span id="1-791"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="1-792">        <span class="k">return</span> <span class="kc">None</span>
</span><span id="1-793">
</span><span id="1-794">    <span class="k">def</span> <span class="nf">start_profiling</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">profile</span><span class="p">):</span>
</span><span id="1-795">        <span class="c1"># type: (Profile) -&gt; None</span>
</span><span id="1-796">        <span class="bp">self</span><span class="o">.</span><span class="n">ensure_running</span><span class="p">()</span>
</span><span id="1-797">        <span class="bp">self</span><span class="o">.</span><span class="n">new_profiles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">profile</span><span class="p">)</span>
</span><span id="1-798">
</span><span id="1-799">    <span class="k">def</span> <span class="nf">make_sampler</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="1-800">        <span class="c1"># type: () -&gt; Callable[..., None]</span>
</span><span id="1-801">        <span class="n">cwd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
</span><span id="1-802">
</span><span id="1-803">        <span class="n">cache</span> <span class="o">=</span> <span class="n">LRUCache</span><span class="p">(</span><span class="n">max_size</span><span class="o">=</span><span class="mi">256</span><span class="p">)</span>
</span><span id="1-804">
</span><span id="1-805">        <span class="k">def</span> <span class="nf">_sample_stack</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="1-806">            <span class="c1"># type: (*Any, **Any) -&gt; None</span>
</span><span id="1-807"><span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="1-808"><span class="sd">            Take a sample of the stack on all the threads in the process.</span>
</span><span id="1-809"><span class="sd">            This should be called at a regular interval to collect samples.</span>
</span><span id="1-810"><span class="sd">            &quot;&quot;&quot;</span>
</span><span id="1-811">            <span class="c1"># no profiles taking place, so we can stop early</span>
</span><span id="1-812">            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_profiles</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">active_profiles</span><span class="p">:</span>
</span><span id="1-813">                <span class="c1"># make sure to clear the cache if we&#39;re not profiling so we dont</span>
</span><span id="1-814">                <span class="c1"># keep a reference to the last stack of frames around</span>
</span><span id="1-815">                <span class="k">return</span>
</span><span id="1-816">
</span><span id="1-817">            <span class="c1"># This is the number of profiles we want to pop off.</span>
</span><span id="1-818">            <span class="c1"># It&#39;s possible another thread adds a new profile to</span>
</span><span id="1-819">            <span class="c1"># the list and we spend longer than we want inside</span>
</span><span id="1-820">            <span class="c1"># the loop below.</span>
</span><span id="1-821">            <span class="c1">#</span>
</span><span id="1-822">            <span class="c1"># Also make sure to set this value before extracting</span>
</span><span id="1-823">            <span class="c1"># frames so we do not write to any new profiles that</span>
</span><span id="1-824">            <span class="c1"># were started after this point.</span>
</span><span id="1-825">            <span class="n">new_profiles</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">new_profiles</span><span class="p">)</span>
</span><span id="1-826">
</span><span id="1-827">            <span class="n">now</span> <span class="o">=</span> <span class="n">nanosecond_time</span><span class="p">()</span>
</span><span id="1-828">
</span><span id="1-829">            <span class="k">try</span><span class="p">:</span>
</span><span id="1-830">                <span class="n">sample</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="1-831">                    <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">tid</span><span class="p">),</span> <span class="n">extract_stack</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">cache</span><span class="p">,</span> <span class="n">cwd</span><span class="p">))</span>
</span><span id="1-832">                    <span class="k">for</span> <span class="n">tid</span><span class="p">,</span> <span class="n">frame</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">_current_frames</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span><span id="1-833">                <span class="p">]</span>
</span><span id="1-834">            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
</span><span id="1-835">                <span class="c1"># For some reason, the frame we get doesn&#39;t have certain attributes.</span>
</span><span id="1-836">                <span class="c1"># When this happens, we abandon the current sample as it&#39;s bad.</span>
</span><span id="1-837">                <span class="n">capture_internal_exception</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">())</span>
</span><span id="1-838">                <span class="k">return</span>
</span><span id="1-839">
</span><span id="1-840">            <span class="c1"># Move the new profiles into the active_profiles set.</span>
</span><span id="1-841">            <span class="c1">#</span>
</span><span id="1-842">            <span class="c1"># We cannot directly add the to active_profiles set</span>
</span><span id="1-843">            <span class="c1"># in `start_profiling` because it is called from other</span>
</span><span id="1-844">            <span class="c1"># threads which can cause a RuntimeError when it the</span>
</span><span id="1-845">            <span class="c1"># set sizes changes during iteration without a lock.</span>
</span><span id="1-846">            <span class="c1">#</span>
</span><span id="1-847">            <span class="c1"># We also want to avoid using a lock here so threads</span>
</span><span id="1-848">            <span class="c1"># that are starting profiles are not blocked until it</span>
</span><span id="1-849">            <span class="c1"># can acquire the lock.</span>
</span><span id="1-850">            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">new_profiles</span><span class="p">):</span>
</span><span id="1-851">                <span class="bp">self</span><span class="o">.</span><span class="n">active_profiles</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">new_profiles</span><span class="o">.</span><span class="n">popleft</span><span class="p">())</span>
</span><span id="1-852">
</span><span id="1-853">            <span class="n">inactive_profiles</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="1-854">
</span><span id="1-855">            <span class="k">for</span> <span class="n">profile</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">active_profiles</span><span class="p">:</span>
</span><span id="1-856">                <span class="k">if</span> <span class="n">profile</span><span class="o">.</span><span class="n">active</span><span class="p">:</span>
</span><span id="1-857">                    <span class="n">profile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">now</span><span class="p">,</span> <span class="n">sample</span><span class="p">)</span>
</span><span id="1-858">                <span class="k">else</span><span class="p">:</span>
</span><span id="1-859">                    <span class="c1"># If a thread is marked inactive, we buffer it</span>
</span><span id="1-860">                    <span class="c1"># to `inactive_profiles` so it can be removed.</span>
</span><span id="1-861">                    <span class="c1"># We cannot remove it here as it would result</span>
</span><span id="1-862">                    <span class="c1"># in a RuntimeError.</span>
</span><span id="1-863">                    <span class="n">inactive_profiles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">profile</span><span class="p">)</span>
</span><span id="1-864">
</span><span id="1-865">            <span class="k">for</span> <span class="n">profile</span> <span class="ow">in</span> <span class="n">inactive_profiles</span><span class="p">:</span>
</span><span id="1-866">                <span class="bp">self</span><span class="o">.</span><span class="n">active_profiles</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">profile</span><span class="p">)</span>
</span><span id="1-867">
</span><span id="1-868">        <span class="k">return</span> <span class="n">_sample_stack</span>
</span><span id="1-869">
</span><span id="1-870">
</span><span id="1-871"><span class="k">class</span> <span class="nc">ThreadScheduler</span><span class="p">(</span><span class="n">Scheduler</span><span class="p">):</span>
</span><span id="1-872"><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="1-873"><span class="sd">    This scheduler is based on running a daemon thread that will call</span>
</span><span id="1-874"><span class="sd">    the sampler at a regular interval.</span>
</span><span id="1-875"><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="1-876">
</span><span id="1-877">    <span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;thread&quot;</span>  <span class="c1"># type: ProfilerMode</span>
</span><span id="1-878">    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;sentry.profiler.ThreadScheduler&quot;</span>
</span><span id="1-879">
</span><span id="1-880">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frequency</span><span class="p">):</span>
</span><span id="1-881">        <span class="c1"># type: (int) -&gt; None</span>
</span><span id="1-882">        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">frequency</span><span class="o">=</span><span class="n">frequency</span><span class="p">)</span>
</span><span id="1-883">
</span><span id="1-884">        <span class="c1"># used to signal to the thread that it should stop</span>
</span><span id="1-885">        <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="1-886">        <span class="bp">self</span><span class="o">.</span><span class="n">thread</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># type: Optional[threading.Thread]</span>
</span><span id="1-887">        <span class="bp">self</span><span class="o">.</span><span class="n">pid</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># type: Optional[int]</span>
</span><span id="1-888">        <span class="bp">self</span><span class="o">.</span><span class="n">lock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>
</span><span id="1-889">
</span><span id="1-890">    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="1-891">        <span class="c1"># type: () -&gt; None</span>
</span><span id="1-892">        <span class="k">pass</span>
</span><span id="1-893">
</span><span id="1-894">    <span class="k">def</span> <span class="nf">teardown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="1-895">        <span class="c1"># type: () -&gt; None</span>
</span><span id="1-896">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">running</span><span class="p">:</span>
</span><span id="1-897">            <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="1-898">            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">thread</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-899">                <span class="bp">self</span><span class="o">.</span><span class="n">thread</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</span><span id="1-900">
</span><span id="1-901">    <span class="k">def</span> <span class="nf">ensure_running</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="1-902">        <span class="c1"># type: () -&gt; None</span>
</span><span id="1-903"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="1-904"><span class="sd">        Check that the profiler has an active thread to run in, and start one if</span>
</span><span id="1-905"><span class="sd">        that&#39;s not the case.</span>
</span><span id="1-906">
</span><span id="1-907"><span class="sd">        Note that this might fail (e.g. in Python 3.12 it&#39;s not possible to</span>
</span><span id="1-908"><span class="sd">        spawn new threads at interpreter shutdown). In that case self.running</span>
</span><span id="1-909"><span class="sd">        will be False after running this function.</span>
</span><span id="1-910"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="1-911">        <span class="n">pid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()</span>
</span><span id="1-912">
</span><span id="1-913">        <span class="c1"># is running on the right process</span>
</span><span id="1-914">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">pid</span> <span class="o">==</span> <span class="n">pid</span><span class="p">:</span>
</span><span id="1-915">            <span class="k">return</span>
</span><span id="1-916">
</span><span id="1-917">        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
</span><span id="1-918">            <span class="c1"># another thread may have tried to acquire the lock</span>
</span><span id="1-919">            <span class="c1"># at the same time so it may start another thread</span>
</span><span id="1-920">            <span class="c1"># make sure to check again before proceeding</span>
</span><span id="1-921">            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">pid</span> <span class="o">==</span> <span class="n">pid</span><span class="p">:</span>
</span><span id="1-922">                <span class="k">return</span>
</span><span id="1-923">
</span><span id="1-924">            <span class="bp">self</span><span class="o">.</span><span class="n">pid</span> <span class="o">=</span> <span class="n">pid</span>
</span><span id="1-925">            <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="1-926">
</span><span id="1-927">            <span class="c1"># make sure the thread is a daemon here otherwise this</span>
</span><span id="1-928">            <span class="c1"># can keep the application running after other threads</span>
</span><span id="1-929">            <span class="c1"># have exited</span>
</span><span id="1-930">            <span class="bp">self</span><span class="o">.</span><span class="n">thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">,</span> <span class="n">daemon</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="1-931">            <span class="k">try</span><span class="p">:</span>
</span><span id="1-932">                <span class="bp">self</span><span class="o">.</span><span class="n">thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</span><span id="1-933">            <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
</span><span id="1-934">                <span class="c1"># Unfortunately at this point the interpreter is in a state that no</span>
</span><span id="1-935">                <span class="c1"># longer allows us to spawn a thread and we have to bail.</span>
</span><span id="1-936">                <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="1-937">                <span class="bp">self</span><span class="o">.</span><span class="n">thread</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="1-938">                <span class="k">return</span>
</span><span id="1-939">
</span><span id="1-940">    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="1-941">        <span class="c1"># type: () -&gt; None</span>
</span><span id="1-942">        <span class="n">last</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
</span><span id="1-943">
</span><span id="1-944">        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">running</span><span class="p">:</span>
</span><span id="1-945">            <span class="bp">self</span><span class="o">.</span><span class="n">sampler</span><span class="p">()</span>
</span><span id="1-946">
</span><span id="1-947">            <span class="c1"># some time may have elapsed since the last time</span>
</span><span id="1-948">            <span class="c1"># we sampled, so we need to account for that and</span>
</span><span id="1-949">            <span class="c1"># not sleep for too long</span>
</span><span id="1-950">            <span class="n">elapsed</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">last</span>
</span><span id="1-951">            <span class="k">if</span> <span class="n">elapsed</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval</span><span class="p">:</span>
</span><span id="1-952">                <span class="n">thread_sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">interval</span> <span class="o">-</span> <span class="n">elapsed</span><span class="p">)</span>
</span><span id="1-953">
</span><span id="1-954">            <span class="c1"># after sleeping, make sure to take the current</span>
</span><span id="1-955">            <span class="c1"># timestamp so we can use it next iteration</span>
</span><span id="1-956">            <span class="n">last</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
</span><span id="1-957">
</span><span id="1-958">
</span><span id="1-959"><span class="k">class</span> <span class="nc">GeventScheduler</span><span class="p">(</span><span class="n">Scheduler</span><span class="p">):</span>
</span><span id="1-960"><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="1-961"><span class="sd">    This scheduler is based on the thread scheduler but adapted to work with</span>
</span><span id="1-962"><span class="sd">    gevent. When using gevent, it may monkey patch the threading modules</span>
</span><span id="1-963"><span class="sd">    (`threading` and `_thread`). This results in the use of greenlets instead</span>
</span><span id="1-964"><span class="sd">    of native threads.</span>
</span><span id="1-965">
</span><span id="1-966"><span class="sd">    This is an issue because the sampler CANNOT run in a greenlet because</span>
</span><span id="1-967"><span class="sd">    1. Other greenlets doing sync work will prevent the sampler from running</span>
</span><span id="1-968"><span class="sd">    2. The greenlet runs in the same thread as other greenlets so when taking</span>
</span><span id="1-969"><span class="sd">       a sample, other greenlets will have been evicted from the thread. This</span>
</span><span id="1-970"><span class="sd">       results in a sample containing only the sampler&#39;s code.</span>
</span><span id="1-971"><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="1-972">
</span><span id="1-973">    <span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;gevent&quot;</span>  <span class="c1"># type: ProfilerMode</span>
</span><span id="1-974">    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;sentry.profiler.GeventScheduler&quot;</span>
</span><span id="1-975">
</span><span id="1-976">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frequency</span><span class="p">):</span>
</span><span id="1-977">        <span class="c1"># type: (int) -&gt; None</span>
</span><span id="1-978">
</span><span id="1-979">        <span class="k">if</span> <span class="n">ThreadPool</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-980">            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Profiler mode: </span><span class="si">{}</span><span class="s2"> is not available&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="p">))</span>
</span><span id="1-981">
</span><span id="1-982">        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">frequency</span><span class="o">=</span><span class="n">frequency</span><span class="p">)</span>
</span><span id="1-983">
</span><span id="1-984">        <span class="c1"># used to signal to the thread that it should stop</span>
</span><span id="1-985">        <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="1-986">        <span class="bp">self</span><span class="o">.</span><span class="n">thread</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># type: Optional[ThreadPool]</span>
</span><span id="1-987">        <span class="bp">self</span><span class="o">.</span><span class="n">pid</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># type: Optional[int]</span>
</span><span id="1-988">
</span><span id="1-989">        <span class="c1"># This intentionally uses the gevent patched threading.Lock.</span>
</span><span id="1-990">        <span class="c1"># The lock will be required when first trying to start profiles</span>
</span><span id="1-991">        <span class="c1"># as we need to spawn the profiler thread from the greenlets.</span>
</span><span id="1-992">        <span class="bp">self</span><span class="o">.</span><span class="n">lock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>
</span><span id="1-993">
</span><span id="1-994">    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="1-995">        <span class="c1"># type: () -&gt; None</span>
</span><span id="1-996">        <span class="k">pass</span>
</span><span id="1-997">
</span><span id="1-998">    <span class="k">def</span> <span class="nf">teardown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="1-999">        <span class="c1"># type: () -&gt; None</span>
</span><span id="1-1000">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">running</span><span class="p">:</span>
</span><span id="1-1001">            <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="1-1002">            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">thread</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-1003">                <span class="bp">self</span><span class="o">.</span><span class="n">thread</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</span><span id="1-1004">
</span><span id="1-1005">    <span class="k">def</span> <span class="nf">ensure_running</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="1-1006">        <span class="c1"># type: () -&gt; None</span>
</span><span id="1-1007">        <span class="n">pid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()</span>
</span><span id="1-1008">
</span><span id="1-1009">        <span class="c1"># is running on the right process</span>
</span><span id="1-1010">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">pid</span> <span class="o">==</span> <span class="n">pid</span><span class="p">:</span>
</span><span id="1-1011">            <span class="k">return</span>
</span><span id="1-1012">
</span><span id="1-1013">        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
</span><span id="1-1014">            <span class="c1"># another thread may have tried to acquire the lock</span>
</span><span id="1-1015">            <span class="c1"># at the same time so it may start another thread</span>
</span><span id="1-1016">            <span class="c1"># make sure to check again before proceeding</span>
</span><span id="1-1017">            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">pid</span> <span class="o">==</span> <span class="n">pid</span><span class="p">:</span>
</span><span id="1-1018">                <span class="k">return</span>
</span><span id="1-1019">
</span><span id="1-1020">            <span class="bp">self</span><span class="o">.</span><span class="n">pid</span> <span class="o">=</span> <span class="n">pid</span>
</span><span id="1-1021">            <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="1-1022">
</span><span id="1-1023">            <span class="bp">self</span><span class="o">.</span><span class="n">thread</span> <span class="o">=</span> <span class="n">ThreadPool</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span id="1-1024">            <span class="k">try</span><span class="p">:</span>
</span><span id="1-1025">                <span class="bp">self</span><span class="o">.</span><span class="n">thread</span><span class="o">.</span><span class="n">spawn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">)</span>
</span><span id="1-1026">            <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
</span><span id="1-1027">                <span class="c1"># Unfortunately at this point the interpreter is in a state that no</span>
</span><span id="1-1028">                <span class="c1"># longer allows us to spawn a thread and we have to bail.</span>
</span><span id="1-1029">                <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="1-1030">                <span class="bp">self</span><span class="o">.</span><span class="n">thread</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="1-1031">                <span class="k">return</span>
</span><span id="1-1032">
</span><span id="1-1033">    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="1-1034">        <span class="c1"># type: () -&gt; None</span>
</span><span id="1-1035">        <span class="n">last</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
</span><span id="1-1036">
</span><span id="1-1037">        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">running</span><span class="p">:</span>
</span><span id="1-1038">            <span class="bp">self</span><span class="o">.</span><span class="n">sampler</span><span class="p">()</span>
</span><span id="1-1039">
</span><span id="1-1040">            <span class="c1"># some time may have elapsed since the last time</span>
</span><span id="1-1041">            <span class="c1"># we sampled, so we need to account for that and</span>
</span><span id="1-1042">            <span class="c1"># not sleep for too long</span>
</span><span id="1-1043">            <span class="n">elapsed</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">last</span>
</span><span id="1-1044">            <span class="k">if</span> <span class="n">elapsed</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval</span><span class="p">:</span>
</span><span id="1-1045">                <span class="n">thread_sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">interval</span> <span class="o">-</span> <span class="n">elapsed</span><span class="p">)</span>
</span><span id="1-1046">
</span><span id="1-1047">            <span class="c1"># after sleeping, make sure to take the current</span>
</span><span id="1-1048">            <span class="c1"># timestamp so we can use it next iteration</span>
</span><span id="1-1049">            <span class="n">last</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
</span></pre></div>
        </article>
        
        <div class="navigation flex print:hidden">
  
  
</div>
        
      </div>
    </div>
  </main>
</div>
<footer class="sy-foot">
  <div class="sy-foot-inner sy-container mx-auto">
    
    <div class="sy-foot-reserved md:flex justify-between items-center">
      <div class="sy-foot-copyright"><p>2019-2024, Sentry Team and Contributors</p>
        
        <p>
          Made with
          
          <a href="https://www.sphinx-doc.org/">Sphinx</a> and
          
          <a href="https://shibuya.lepture.com">Shibuya theme</a>.
        </p>
      </div>
      <div class="sy-foot-socials">
          <a href="https://github.com/getsentry/sentry-python" aria-label="GitHub"><i class="i-icon github"></i></a>
      </div>
    </div>
  </div>
</footer></div>
      <script src="../../_static/documentation_options.js?v=944fa962"></script>
      <script src="../../_static/doctools.js?v=888ff710"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../../_static/shibuya.js?v=ccb09f80"></script>
    
</body>
</html>